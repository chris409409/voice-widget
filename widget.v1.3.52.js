"use strict";var voiceSaasWidget=(()=>{(function(){let f=document.currentScript,x="1.3.50-fixed",u={agentId:f.getAttribute("data-agent-id"),jwtEndpoint:f.getAttribute("data-jwt-endpoint"),tokenUrl:f.getAttribute("data-token-endpoint"),name:f.getAttribute("data-name")||"Assistant",themeColor:f.getAttribute("data-theme-color")||"#0077ff",position:f.getAttribute("data-position")||"bottom-right"},o=t=>{window.DEBUG_WIDGET&&console.log(`[VoiceSaaS Widget] ${t}`)};function k(t){requestAnimationFrame(()=>{t.scrollTop=t.scrollHeight})}o(`Widget loaded (version ${x})`);function S(){if(window.__vsStylesInjected)return;window.__vsStylesInjected=!0;let t=new URL(f.src).origin,n=document.createElement("link");return n.id="vs-widget-css",n.rel="stylesheet",n.href=f.src.replace(/\.js$/,".css"),document.head.appendChild(n),n}function L(){let t=document.createElement("style");t.textContent=`
      .voice-saas-widget-button {
        background: ${u.themeColor};
      }
      .voice-saas-widget-header {
        background: ${u.themeColor};
      }
      .voice-saas-widget-message.user {
        background: ${u.themeColor};
      }
      .voice-saas-widget-retry-button {
        background: ${u.themeColor};
      }
    `,document.head.appendChild(t)}function E(t,n,c=!1){let e=document.createElement("div");return e.className=`voice-saas-widget-message ${c?"user":"assistant"}`,e.textContent=n,t.messagesContainer.appendChild(e),k(t.messagesContainer),e}function y(t,n,c){if(c.kind!=="audio")return;o("Received audio track from assistant");let e=c.attach();e.autoplay=!0,e.volume=1,e.style.display="none",t.audioContainer.appendChild(e),n&&n.state==="running"&&n.createMediaStreamSource(new MediaStream([c.mediaStreamTrack])).connect(n.destination)}function N(t){let n=document.createElement("div");n.className="voice-saas-widget-thinking";for(let c=0;c<3;c++){let e=document.createElement("span");n.appendChild(e)}return t.messagesContainer.appendChild(n),k(t.messagesContainer),n}function M(){let t=document.createElement("div");t.className="voice-saas-widget-dialog",t.id="vs-chat",Object.assign(t.style,{position:"fixed",right:"24px",bottom:"80px",width:"380px",height:"600px",borderRadius:"12px",boxShadow:"0 4px 16px rgba(0,0,0,0.2)",background:"#ffffff",display:"none",zIndex:"9999",overflow:"hidden",flexDirection:"column"}),t.innerHTML="";let n=document.createElement("div");n.className="voice-saas-widget-header",Object.assign(n.style,{background:u.themeColor,color:"#ffffff",padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"});let c=document.createElement("div");c.textContent=u.name,c.style.fontWeight="bold";let e=document.createElement("button");e.innerHTML="\u2715",e.className="voice-saas-widget-close-button",Object.assign(e.style,{background:"transparent",border:"none",color:"#ffffff",cursor:"pointer",fontSize:"16px"}),n.appendChild(c),n.appendChild(e),t.appendChild(n);let i=document.createElement("div");i.className="voice-saas-widget-content",Object.assign(i.style,{flex:"1",padding:"16px",overflowY:"auto",height:"calc(100% - 100px)"});let h=document.createElement("div");h.className="voice-saas-widget-messages",i.appendChild(h),t.appendChild(i);let p=document.createElement("div");p.className="voice-saas-widget-footer",Object.assign(p.style,{borderTop:"1px solid #eee",padding:"12px 16px",display:"flex",alignItems:"center"});let r=document.createElement("div");r.className="voice-saas-widget-status",r.textContent="Click microphone to speak",r.style.fontSize="14px",r.style.color="#666",r.style.flex="1",p.appendChild(r),t.appendChild(p);let s=document.createElement("div");return s.id="voice-saas-widget-audio-container",s.style.display="none",t.appendChild(s),document.body.appendChild(t),{panel:t,elements:{messagesContainer:h,closeButton:e,statusIndicator:r,audioContainer:s}}}async function I(){let t=[],n=document.createElement("button");n.className="voice-saas-widget-button",n.innerHTML="\u{1F399}\uFE0F",Object.assign(n.style,{position:"fixed",bottom:"20px",right:"20px",width:"60px",height:"60px",borderRadius:"50%",background:u.themeColor,color:"#ffffff",border:"none",boxShadow:"0 4px 8px rgba(0,0,0,0.2)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"24px",zIndex:"9998"}),document.body.appendChild(n);let{panel:c,elements:e}=M();o("Widget UI created");let i=null,h=!1,p=!1,r=null,s=null;e.closeButton.addEventListener("click",()=>{c.style.display="none",$(),t.length=0,e.messagesContainer.innerHTML=""});async function $(){r&&(o("Stopping microphone track"),r.stop(),r=null);let l=c.querySelector(".unmute-button");if(l&&l.remove(),i&&(o("Disconnecting from LiveKit"),await i.disconnect(),i=null,h=!1,p=!1),s&&s.state!=="closed"){try{await s.close(),o("AudioContext closed")}catch(m){console.warn("Error closing AudioContext:",m)}s=null}e.audioContainer&&(e.audioContainer.innerHTML=""),t.length=0,e.messagesContainer.innerHTML="",e.statusIndicator.textContent="Click microphone to speak"}n.addEventListener("click",async()=>{if(c.style.display==="none"){if(c.style.display="flex",!h)try{if(e.statusIndicator.textContent="Requesting microphone access...",!window.LivekitClient&&!window.livekit&&!window.__loadingLiveKit){window.__loadingLiveKit=!0,o("Loading LiveKit client library");try{await new Promise((a,d)=>{if(document.querySelector('script[src*="livekit-client"]'))return o("LiveKit script already exists, waiting for it to load"),a();let w=document.createElement("script");w.src="https://cdn.jsdelivr.net/npm/livekit-client@2.11.0/dist/livekit-client.umd.min.js",w.onload=a,w.onerror=d,document.head.appendChild(w)}),o("LiveKit client library loaded successfully")}catch(a){throw window.__loadingLiveKit=!1,new Error(`Failed to load LiveKit: ${a.message}`)}}else if(window.__loadingLiveKit)for(o("Waiting for LiveKit to finish loading");window.__loadingLiveKit&&!window.LivekitClient&&!window.livekit;)await new Promise(a=>setTimeout(a,100));let l=window.LivekitClient||window.livekit;if(!l)throw new Error("Failed to load LiveKit client");r=await l.createLocalAudioTrack({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}),o("Microphone access granted"),e.statusIndicator.textContent="Setting up audio...",s=new(window.AudioContext||window.webkitAudioContext);try{await s.resume(),o("AudioContext resumed successfully")}catch(a){console.warn("AudioContext.resume() failed:",a),o(`AudioContext resume error: ${a.message}`)}try{let a=s.createBuffer(1,1,s.sampleRate),d=s.createBufferSource();d.buffer=a,d.connect(s.destination),d.start(),o("Silent buffer played to unlock audio")}catch(a){console.warn("Silent buffer playback failed:",a),o(`Silent buffer error: ${a.message}`)}e.statusIndicator.textContent="Connecting...";let m=await fetch(u.jwtEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:u.agentId}),credentials:"include"});if(!m.ok)throw new Error("Failed to get widget authentication");let{jwt:b}=await m.json(),C=Date.now(),T=`agent-${u.agentId}-${C}`;o(`Generated room name: ${T}`);let j=await fetch(u.tokenUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:u.agentId,roomName:T,jwtFromWidget:b}),credentials:"include"});if(!j.ok)throw new Error("Failed to get connection token");let{token:K,url:R}=await j.json();i=new l.Room({adaptiveStream:!0,dynacast:!0,webaudio:{audioContext:s}}),await i.connect(R,K),i.on("trackSubscribed",a=>{y(e,s,a)}),i.remoteParticipants.forEach(a=>{a.trackPublications.forEach(d=>{d.isSubscribed&&d.track&&y(e,s,d.track)}),a.on("trackSubscribed",d=>{y(e,s,d)})}),o(`Found ${i.remoteParticipants.size} participants already in the room`),o("Connected to LiveKit room using v2 API");try{await i.startAudio(),o("Room audio started successfully")}catch(a){console.warn("room.startAudio() failed:",a),o(`Room audio start error: ${a.message}`);let d=document.createElement("button");d.textContent="\u{1F50A} Tap to unmute",d.className="unmute-button",Object.assign(d.style,{position:"absolute",bottom:"8px",right:"8px",zIndex:"999",padding:"8px 12px",background:"#0077ff",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"}),d.onclick=async()=>{try{await i.startAudio(),d.remove()}catch(w){console.error("Failed to start audio:",w)}},c.appendChild(d)}h=!0,o("Connected to LiveKit room"),r?(await i.localParticipant.publishTrack(r),p=!0,e.statusIndicator.textContent="Listening...",o("Microphone track published")):(o("Warning: No microphone track available to publish"),e.statusIndicator.textContent="Microphone unavailable"),i.on("participantConnected",a=>{o(`${a.identity} connected`)}),i.on("dataReceived",(a,d,w,O)=>{if(O!=="conversation")return;let v;try{v=JSON.parse(new TextDecoder().decode(a))}catch(g){console.error("[Widget] Ung\xFCltiges JSON im Datenkanal:",g);return}if(t.push(v),t.sort((g,_)=>g.timestamp-_.timestamp),e.messagesContainer.innerHTML="",t.forEach(g=>{E(e,g.text,g.role==="user")}),v.role==="user")N(e),e.statusIndicator.textContent="Assistant is thinking...";else if(v.role==="assistant"||v.role==="system"){let g=document.querySelector(".voice-saas-widget-thinking");g&&g.remove(),e.statusIndicator.textContent="Listening..."}})}catch(l){if(o(`Error: ${l.message}`),l.name==="NotAllowedError"){e.statusIndicator.textContent="Microphone access denied";let m=document.createElement("button");m.textContent="\u{1F399}\uFE0F Allow microphone access",m.className="voice-saas-widget-retry-button",Object.assign(m.style,{margin:"10px auto",display:"block",padding:"8px 16px",background:u.themeColor,color:"white",border:"none",borderRadius:"4px",cursor:"pointer"});let b=c.querySelector(".voice-saas-widget-retry-button");b&&b.remove(),e.messagesContainer.appendChild(m),m.addEventListener("click",async()=>{if(m.remove(),navigator.permissions&&navigator.permissions.query)try{let C=await navigator.permissions.query({name:"microphone"});if(o(`Microphone permission status: ${C.state}`),C.state==="denied"){E(e,"Please enable microphone access in your browser settings and refresh the page.",!1);return}}catch(C){o(`Error checking permissions: ${C.message}`)}c.style.display="none",setTimeout(()=>n.click(),500)})}else l.message.includes("WebSocket")?e.statusIndicator.textContent="Network error":e.statusIndicator.textContent="Connection failed"}}else if(h)if(p)i&&(i.localParticipant.unpublishAllTracks(),r&&(r.stop(),r=null),p=!1,e.statusIndicator.textContent="Microphone off",n.style.background="#999");else try{e.statusIndicator.textContent="Requesting microphone access...",r=await(window.LivekitClient||window.livekit).createLocalAudioTrack({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}),await i.localParticipant.publishTrack(r),p=!0,e.statusIndicator.textContent="Listening...",n.style.background=u.themeColor}catch(l){o(`Microphone reactivation error: ${l.message}`),l.name==="NotAllowedError"?e.statusIndicator.textContent="Microphone access denied":l.message.includes("WebSocket")?e.statusIndicator.textContent="Network error":e.statusIndicator.textContent="Could not access microphone"}}),document.addEventListener("click",function l(){s&&s.state==="suspended"&&s.resume().then(()=>o("AudioContext resumed by user interaction")).catch(m=>console.warn("AudioContext resume error:",m)),i&&i.startAudio().then(()=>o("LiveKit audio started by user interaction")).catch(m=>console.warn("LiveKit startAudio error:",m)),document.removeEventListener("click",l)},{once:!0}),window.addEventListener("beforeunload",()=>{r&&(r.stop(),r=null),i&&i.disconnect(),s&&s.state!=="closed"&&s.close().catch(()=>{}),e.audioContainer&&(e.audioContainer.innerHTML="")})}function A(){S(),L(),I()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A(),window.VoiceSaasWidget={version:x,createWidget:function(t){return Object.assign(u,t),S(),L(),I()}}})();})();
//# sourceMappingURL=widget.bundle.js.map
