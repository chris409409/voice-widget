"use strict";var voiceSaasWidget=(()=>{(function(){let w=document.currentScript,x="1.3.50-fixed",d={agentId:w.getAttribute("data-agent-id"),jwtEndpoint:w.getAttribute("data-jwt-endpoint"),tokenUrl:w.getAttribute("data-token-endpoint"),name:w.getAttribute("data-name")||"Assistant",themeColor:w.getAttribute("data-theme-color")||"#0077ff",position:w.getAttribute("data-position")||"bottom-right"},o=t=>{window.DEBUG_WIDGET&&console.log(`[VoiceSaaS Widget] ${t}`)};function k(t){requestAnimationFrame(()=>{t.scrollTop=t.scrollHeight})}o(`Widget loaded (version ${x})`);function S(){if(window.__vsStylesInjected)return;window.__vsStylesInjected=!0;let t=new URL(w.src).origin,i=document.createElement("link");return i.id="vs-widget-css",i.rel="stylesheet",i.href=w.src.replace(/\.js$/,".css"),document.head.appendChild(i),i}function E(){let t=document.createElement("style");t.textContent=`
      .voice-saas-widget-button {
        background: ${d.themeColor};
      }
      .voice-saas-widget-header {
        background: ${d.themeColor};
      }
      .voice-saas-widget-message.user {
        background: ${d.themeColor};
      }
      .voice-saas-widget-retry-button {
        background: ${d.themeColor};
      }
    `,document.head.appendChild(t)}function L(t,i,l=!1){let e=document.createElement("div");return e.className=`voice-saas-widget-message ${l?"user":"assistant"}`,e.textContent=i,t.messagesContainer.appendChild(e),k(t.messagesContainer),e}function b(t,i,l){if(l.kind!=="audio")return;o("Received audio track from assistant");let e=l.attach();e.autoplay=!0,e.volume=1,e.style.display="none",t.audioContainer.appendChild(e),i&&i.state==="running"&&i.createMediaStreamSource(new MediaStream([l.mediaStreamTrack])).connect(i.destination)}function A(t){let i=document.createElement("div");i.className="voice-saas-widget-thinking";for(let l=0;l<3;l++){let e=document.createElement("span");i.appendChild(e)}return t.messagesContainer.appendChild(i),k(t.messagesContainer),i}function j(){let t=document.createElement("div");t.className="voice-saas-widget-dialog",t.id="vs-chat",Object.assign(t.style,{position:"fixed",right:"24px",bottom:"80px",width:"380px",height:"600px",borderRadius:"12px",boxShadow:"0 4px 16px rgba(0,0,0,0.2)",background:"#ffffff",display:"none",zIndex:"9999",overflow:"hidden",flexDirection:"column"}),t.innerHTML="";let i=document.createElement("div");i.className="voice-saas-widget-header",Object.assign(i.style,{background:d.themeColor,color:"#ffffff",padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"});let l=document.createElement("div");l.textContent=d.name,l.style.fontWeight="bold";let e=document.createElement("button");e.innerHTML="\u2715",e.className="voice-saas-widget-close-button",Object.assign(e.style,{background:"transparent",border:"none",color:"#ffffff",cursor:"pointer",fontSize:"16px"}),i.appendChild(l),i.appendChild(e),t.appendChild(i);let s=document.createElement("div");s.className="voice-saas-widget-content",Object.assign(s.style,{flex:"1",padding:"16px",overflowY:"auto",height:"calc(100% - 100px)"});let C=document.createElement("div");C.className="voice-saas-widget-messages",s.appendChild(C),t.appendChild(s);let f=document.createElement("div");f.className="voice-saas-widget-footer",Object.assign(f.style,{borderTop:"1px solid #eee",padding:"12px 16px",display:"flex",alignItems:"center"});let c=document.createElement("div");c.className="voice-saas-widget-status",c.textContent="Click microphone to speak",c.style.fontSize="14px",c.style.color="#666",c.style.flex="1",f.appendChild(c),t.appendChild(f);let r=document.createElement("div");return r.id="voice-saas-widget-audio-container",r.style.display="none",t.appendChild(r),document.body.appendChild(t),{panel:t,elements:{messagesContainer:C,closeButton:e,statusIndicator:c,audioContainer:r}}}async function I(){let t=[],i=document.createElement("button");i.className="voice-saas-widget-button",i.innerHTML="\u{1F399}\uFE0F",Object.assign(i.style,{position:"fixed",bottom:"20px",right:"20px",width:"60px",height:"60px",borderRadius:"50%",background:d.themeColor,color:"#ffffff",border:"none",boxShadow:"0 4px 8px rgba(0,0,0,0.2)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"24px",zIndex:"9998"}),document.body.appendChild(i);let{panel:l,elements:e}=j();o("Widget UI created");let s=null,C=!1,f=!1,c=null,r=null;e.closeButton.addEventListener("click",()=>{l.style.display="none",N(),t.length=0,e.messagesContainer.innerHTML=""});async function N(){c&&(o("Stopping microphone track"),c.stop(),c=null);let u=l.querySelector(".unmute-button");if(u&&u.remove(),s&&(o("Disconnecting from LiveKit"),await s.disconnect(),s=null,C=!1,f=!1),r&&r.state!=="closed"){try{await r.close(),o("AudioContext closed")}catch(m){console.warn("Error closing AudioContext:",m)}r=null}e.audioContainer&&(e.audioContainer.innerHTML=""),t.length=0,e.messagesContainer.innerHTML="",e.statusIndicator.textContent="Click microphone to speak"}i.addEventListener("click",async()=>{if(l.style.display==="none"){if(l.style.display="flex",!C)try{if(e.statusIndicator.textContent="Requesting microphone access...",!window.LivekitClient&&!window.livekit&&!window.__loadingLiveKit){window.__loadingLiveKit=!0,o("Loading LiveKit client library");try{await new Promise((n,a)=>{if(document.querySelector('script[src*="livekit-client"]'))return o("LiveKit script already exists, waiting for it to load"),n();let p=document.createElement("script");p.src="https://cdn.jsdelivr.net/npm/livekit-client@2.11.0/dist/livekit-client.umd.min.js",p.onload=n,p.onerror=a,document.head.appendChild(p)}),o("LiveKit client library loaded successfully")}catch(n){throw window.__loadingLiveKit=!1,new Error(`Failed to load LiveKit: ${n.message}`)}}else if(window.__loadingLiveKit)for(o("Waiting for LiveKit to finish loading");window.__loadingLiveKit&&!window.LivekitClient&&!window.livekit;)await new Promise(n=>setTimeout(n,100));let u=window.LivekitClient||window.livekit;if(!u)throw new Error("Failed to load LiveKit client");c=await u.createLocalAudioTrack({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}),o("Microphone access granted"),e.statusIndicator.textContent="Setting up audio...",r=new(window.AudioContext||window.webkitAudioContext);try{await r.resume(),o("AudioContext resumed successfully")}catch(n){console.warn("AudioContext.resume() failed:",n),o(`AudioContext resume error: ${n.message}`)}try{let n=r.createBuffer(1,1,r.sampleRate),a=r.createBufferSource();a.buffer=n,a.connect(r.destination),a.start(),o("Silent buffer played to unlock audio")}catch(n){console.warn("Silent buffer playback failed:",n),o(`Silent buffer error: ${n.message}`)}if(e.statusIndicator.textContent="Connecting...",d.jwtEndpoint&&d.jwtEndpoint.includes("localhost")){o("Test mode detected - using single endpoint");let n=Date.now(),a=`agent-${d.agentId}-${n}`;o(`Generated room name: ${a}`);let p=await fetch(d.tokenUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:d.agentId,roomName:a})});if(!p.ok)throw new Error("Failed to get connection token");let{token:v,serverUrl:h}=await p.json();s=new u.Room({adaptiveStream:!0,dynacast:!0,webaudio:{audioContext:r}}),await s.connect(h,v)}else{o("Production mode - using two-step authentication");let n=await fetch(d.jwtEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:d.agentId}),credentials:"include"});if(!n.ok)throw new Error("Failed to get widget authentication");let{jwt:a}=await n.json(),p=Date.now(),v=`agent-${d.agentId}-${p}`;o(`Generated room name: ${v}`);let h=await fetch(d.tokenUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:d.agentId,roomName:v,jwtFromWidget:a}),credentials:"include"});if(!h.ok)throw new Error("Failed to get connection token");let{token:g,url:y}=await h.json();s=new u.Room({adaptiveStream:!0,dynacast:!0,webaudio:{audioContext:r}}),await s.connect(y,g)}s.on("trackSubscribed",n=>{b(e,r,n)}),s.remoteParticipants.forEach(n=>{n.trackPublications.forEach(a=>{a.isSubscribed&&a.track&&b(e,r,a.track)}),n.on("trackSubscribed",a=>{b(e,r,a)})}),o(`Found ${s.remoteParticipants.size} participants already in the room`),o("Connected to LiveKit room using v2 API");try{await s.startAudio(),o("Room audio started successfully")}catch(n){console.warn("room.startAudio() failed:",n),o(`Room audio start error: ${n.message}`);let a=document.createElement("button");a.textContent="\u{1F50A} Tap to unmute",a.className="unmute-button",Object.assign(a.style,{position:"absolute",bottom:"8px",right:"8px",zIndex:"999",padding:"8px 12px",background:"#0077ff",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"}),a.onclick=async()=>{try{await s.startAudio(),a.remove()}catch(p){console.error("Failed to start audio:",p)}},l.appendChild(a)}C=!0,o("Connected to LiveKit room"),c?(await s.localParticipant.publishTrack(c),f=!0,e.statusIndicator.textContent="Listening...",o("Microphone track published")):(o("Warning: No microphone track available to publish"),e.statusIndicator.textContent="Microphone unavailable"),s.on("participantConnected",n=>{o(`${n.identity} connected`)}),s.on("dataReceived",(n,a,p,v)=>{if(v!=="conversation")return;let h;try{h=JSON.parse(new TextDecoder().decode(n))}catch(g){console.error("[Widget] Ung\xFCltiges JSON im Datenkanal:",g);return}if(t.push(h),t.sort((g,y)=>g.timestamp-y.timestamp),e.messagesContainer.innerHTML="",t.forEach(g=>{L(e,g.text,g.role==="user")}),h.role==="user")A(e),e.statusIndicator.textContent="Assistant is thinking...";else if(h.role==="assistant"||h.role==="system"){let g=document.querySelector(".voice-saas-widget-thinking");g&&g.remove(),e.statusIndicator.textContent="Listening..."}})}catch(u){if(o(`Error: ${u.message}`),u.name==="NotAllowedError"){e.statusIndicator.textContent="Microphone access denied";let m=document.createElement("button");m.textContent="\u{1F399}\uFE0F Allow microphone access",m.className="voice-saas-widget-retry-button",Object.assign(m.style,{margin:"10px auto",display:"block",padding:"8px 16px",background:d.themeColor,color:"white",border:"none",borderRadius:"4px",cursor:"pointer"});let n=l.querySelector(".voice-saas-widget-retry-button");n&&n.remove(),e.messagesContainer.appendChild(m),m.addEventListener("click",async()=>{if(m.remove(),navigator.permissions&&navigator.permissions.query)try{let a=await navigator.permissions.query({name:"microphone"});if(o(`Microphone permission status: ${a.state}`),a.state==="denied"){L(e,"Please enable microphone access in your browser settings and refresh the page.",!1);return}}catch(a){o(`Error checking permissions: ${a.message}`)}l.style.display="none",setTimeout(()=>i.click(),500)})}else u.message.includes("WebSocket")?e.statusIndicator.textContent="Network error":e.statusIndicator.textContent="Connection failed"}}else if(C)if(f)s&&(s.localParticipant.unpublishAllTracks(),c&&(c.stop(),c=null),f=!1,e.statusIndicator.textContent="Microphone off",i.style.background="#999");else try{e.statusIndicator.textContent="Requesting microphone access...",c=await(window.LivekitClient||window.livekit).createLocalAudioTrack({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}),await s.localParticipant.publishTrack(c),f=!0,e.statusIndicator.textContent="Listening...",i.style.background=d.themeColor}catch(u){o(`Microphone reactivation error: ${u.message}`),u.name==="NotAllowedError"?e.statusIndicator.textContent="Microphone access denied":u.message.includes("WebSocket")?e.statusIndicator.textContent="Network error":e.statusIndicator.textContent="Could not access microphone"}}),document.addEventListener("click",function u(){r&&r.state==="suspended"&&r.resume().then(()=>o("AudioContext resumed by user interaction")).catch(m=>console.warn("AudioContext resume error:",m)),s&&s.startAudio().then(()=>o("LiveKit audio started by user interaction")).catch(m=>console.warn("LiveKit startAudio error:",m)),document.removeEventListener("click",u)},{once:!0}),window.addEventListener("beforeunload",()=>{c&&(c.stop(),c=null),s&&s.disconnect(),r&&r.state!=="closed"&&r.close().catch(()=>{}),e.audioContainer&&(e.audioContainer.innerHTML="")})}function T(){S(),E(),I()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",T):T(),window.VoiceSaasWidget={version:x,createWidget:function(t){return Object.assign(d,t),S(),E(),I()}}})();})();
//# sourceMappingURL=widget.bundle.js.map
