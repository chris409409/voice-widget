"use strict";var voiceSaasWidget=(()=>{(function(){let h=document.currentScript,k="1.3.50-fixed",u={agentId:h.getAttribute("data-agent-id"),jwtEndpoint:h.getAttribute("data-jwt-endpoint"),tokenUrl:h.getAttribute("data-token-endpoint"),name:h.getAttribute("data-name")||"Assistant",themeColor:h.getAttribute("data-theme-color")||"#0077ff",position:h.getAttribute("data-position")||"bottom-right"},o=t=>{window.DEBUG_WIDGET&&console.log(`[VoiceSaaS Widget] ${t}`)};function L(t){requestAnimationFrame(()=>{t.scrollTop=t.scrollHeight})}o(`Widget loaded (version ${k})`);function S(){if(window.__vsStylesInjected)return;window.__vsStylesInjected=!0;let t=new URL(h.src).origin,n=document.createElement("link");return n.id="vs-widget-css",n.rel="stylesheet",n.href=h.src.replace(/\.js$/,".css"),document.head.appendChild(n),n}function E(){let t=document.createElement("style");t.textContent=`
      .voice-saas-widget-button {
        background: ${u.themeColor};
      }
      .voice-saas-widget-header {
        background: ${u.themeColor};
      }
      .voice-saas-widget-message.user {
        background: ${u.themeColor};
      }
      .voice-saas-widget-retry-button {
        background: ${u.themeColor};
      }
    `,document.head.appendChild(t)}function I(t,n,c=!1){let e=document.createElement("div");return e.className=`voice-saas-widget-message ${c?"user":"assistant"}`,e.textContent=n,t.messagesContainer.appendChild(e),L(t.messagesContainer),e}function x(t,n,c){if(c.kind!=="audio")return;o("Received audio track from assistant");let e=c.attach();e.autoplay=!0,e.volume=1,e.style.display="none",t.audioContainer.appendChild(e),n&&n.state==="running"&&n.createMediaStreamSource(new MediaStream([c.mediaStreamTrack])).connect(n.destination)}function M(t){let n=document.createElement("div");n.className="voice-saas-widget-thinking";for(let c=0;c<3;c++){let e=document.createElement("span");n.appendChild(e)}return t.messagesContainer.appendChild(n),L(t.messagesContainer),n}function $(){let t=document.createElement("div");t.className="voice-saas-widget-dialog",t.id="vs-chat",Object.assign(t.style,{position:"fixed",right:"24px",bottom:"80px",width:"380px",height:"600px",borderRadius:"12px",boxShadow:"0 4px 16px rgba(0,0,0,0.2)",background:"#ffffff",display:"none",zIndex:"9999",overflow:"hidden",flexDirection:"column"}),t.innerHTML="";let n=document.createElement("div");n.className="voice-saas-widget-header",Object.assign(n.style,{background:u.themeColor,color:"#ffffff",padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"});let c=document.createElement("div");c.textContent=u.name,c.style.fontWeight="bold";let e=document.createElement("button");e.innerHTML="\u2715",e.className="voice-saas-widget-close-button",Object.assign(e.style,{background:"transparent",border:"none",color:"#ffffff",cursor:"pointer",fontSize:"16px"}),n.appendChild(c),n.appendChild(e),t.appendChild(n);let a=document.createElement("div");a.className="voice-saas-widget-content",Object.assign(a.style,{flex:"1",padding:"16px",overflowY:"auto",height:"calc(100% - 100px)"});let g=document.createElement("div");g.className="voice-saas-widget-messages",a.appendChild(g),t.appendChild(a);let p=document.createElement("div");p.className="voice-saas-widget-footer",Object.assign(p.style,{borderTop:"1px solid #eee",padding:"12px 16px",display:"flex",alignItems:"center"});let r=document.createElement("div");r.className="voice-saas-widget-status",r.textContent="Click microphone to speak",r.style.fontSize="14px",r.style.color="#666",r.style.flex="1";let i=document.createElement("button");i.innerHTML="\u{1F6AB}",i.className="voice-saas-widget-disconnect-button",i.title="Disconnect from conversation",Object.assign(i.style,{background:"#ff4444",border:"none",color:"#ffffff",cursor:"pointer",fontSize:"16px",padding:"6px 12px",borderRadius:"4px",marginLeft:"8px",display:"none"}),p.appendChild(r),p.appendChild(i),t.appendChild(p);let w=document.createElement("div");return w.id="voice-saas-widget-audio-container",w.style.display="none",t.appendChild(w),document.body.appendChild(t),{panel:t,elements:{messagesContainer:g,closeButton:e,disconnectButton:i,statusIndicator:r,audioContainer:w}}}async function A(){let t=[],n=document.createElement("button");n.className="voice-saas-widget-button",n.innerHTML="\u{1F399}\uFE0F",Object.assign(n.style,{position:"fixed",bottom:"20px",right:"20px",width:"60px",height:"60px",borderRadius:"50%",background:u.themeColor,color:"#ffffff",border:"none",boxShadow:"0 4px 8px rgba(0,0,0,0.2)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"24px",zIndex:"9998"}),document.body.appendChild(n);let{panel:c,elements:e}=$();o("Widget UI created");let a=null,g=!1,p=!1,r=null,i=null;e.closeButton.addEventListener("click",()=>{c.style.display="none",w(),t.length=0,e.messagesContainer.innerHTML=""}),e.disconnectButton.addEventListener("click",async()=>{g&&(e.statusIndicator.textContent="Disconnecting...",await w(),e.statusIndicator.textContent="Disconnected - Click microphone to reconnect",e.disconnectButton.style.display="none",n.style.background="#999",t.length=0,e.messagesContainer.innerHTML="")});async function w(){r&&(o("Stopping microphone track"),r.stop(),r=null);let l=c.querySelector(".unmute-button");if(l&&l.remove(),a&&(o("Disconnecting from LiveKit"),await a.disconnect(),a=null,g=!1,p=!1),i&&i.state!=="closed"){try{await i.close(),o("AudioContext closed")}catch(m){console.warn("Error closing AudioContext:",m)}i=null}e.audioContainer&&(e.audioContainer.innerHTML=""),t.length=0,e.messagesContainer.innerHTML="",e.disconnectButton.style.display="none",e.statusIndicator.textContent="Click microphone to speak"}n.addEventListener("click",async()=>{if(c.style.display==="none"){if(c.style.display="flex",!g)try{if(e.statusIndicator.textContent="Requesting microphone access...",!window.LivekitClient&&!window.livekit&&!window.__loadingLiveKit){window.__loadingLiveKit=!0,o("Loading LiveKit client library");try{await new Promise((s,d)=>{if(document.querySelector('script[src*="livekit-client"]'))return o("LiveKit script already exists, waiting for it to load"),s();let b=document.createElement("script");b.src="https://cdn.jsdelivr.net/npm/livekit-client@2.11.0/dist/livekit-client.umd.min.js",b.onload=s,b.onerror=d,document.head.appendChild(b)}),o("LiveKit client library loaded successfully")}catch(s){throw window.__loadingLiveKit=!1,new Error(`Failed to load LiveKit: ${s.message}`)}}else if(window.__loadingLiveKit)for(o("Waiting for LiveKit to finish loading");window.__loadingLiveKit&&!window.LivekitClient&&!window.livekit;)await new Promise(s=>setTimeout(s,100));let l=window.LivekitClient||window.livekit;if(!l)throw new Error("Failed to load LiveKit client");r=await l.createLocalAudioTrack({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}),o("Microphone access granted"),e.statusIndicator.textContent="Setting up audio...",i=new(window.AudioContext||window.webkitAudioContext);try{await i.resume(),o("AudioContext resumed successfully")}catch(s){console.warn("AudioContext.resume() failed:",s),o(`AudioContext resume error: ${s.message}`)}try{let s=i.createBuffer(1,1,i.sampleRate),d=i.createBufferSource();d.buffer=s,d.connect(i.destination),d.start(),o("Silent buffer played to unlock audio")}catch(s){console.warn("Silent buffer playback failed:",s),o(`Silent buffer error: ${s.message}`)}e.statusIndicator.textContent="Connecting...";let m=await fetch(u.jwtEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:u.agentId}),credentials:"include"});if(!m.ok)throw new Error("Failed to get widget authentication");let{jwt:y}=await m.json(),C=Date.now(),j=`agent-${u.agentId}-${C}`;o(`Generated room name: ${j}`);let N=await fetch(u.tokenUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agentId:u.agentId,roomName:j,jwtFromWidget:y}),credentials:"include"});if(!N.ok)throw new Error("Failed to get connection token");let{token:K,url:R}=await N.json();a=new l.Room({adaptiveStream:!0,dynacast:!0,webaudio:{audioContext:i}}),await a.connect(R,K),a.on("trackSubscribed",s=>{x(e,i,s)}),a.remoteParticipants.forEach(s=>{s.trackPublications.forEach(d=>{d.isSubscribed&&d.track&&x(e,i,d.track)}),s.on("trackSubscribed",d=>{x(e,i,d)})}),o(`Found ${a.remoteParticipants.size} participants already in the room`),o("Connected to LiveKit room using v2 API");try{await a.startAudio(),o("Room audio started successfully")}catch(s){console.warn("room.startAudio() failed:",s),o(`Room audio start error: ${s.message}`);let d=document.createElement("button");d.textContent="\u{1F50A} Tap to unmute",d.className="unmute-button",Object.assign(d.style,{position:"absolute",bottom:"8px",right:"8px",zIndex:"999",padding:"8px 12px",background:"#0077ff",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"}),d.onclick=async()=>{try{await a.startAudio(),d.remove()}catch(b){console.error("Failed to start audio:",b)}},c.appendChild(d)}g=!0,o("Connected to LiveKit room"),e.disconnectButton.style.display="inline-block",r?(await a.localParticipant.publishTrack(r),p=!0,e.statusIndicator.textContent="Listening...",o("Microphone track published")):(o("Warning: No microphone track available to publish"),e.statusIndicator.textContent="Microphone unavailable"),a.on("participantConnected",s=>{o(`${s.identity} connected`)}),a.on("dataReceived",(s,d,b,B)=>{if(B!=="conversation")return;let v;try{v=JSON.parse(new TextDecoder().decode(s))}catch(f){console.error("[Widget] Ung\xFCltiges JSON im Datenkanal:",f);return}if(t.push(v),t.sort((f,O)=>f.timestamp-O.timestamp),e.messagesContainer.innerHTML="",t.forEach(f=>{I(e,f.text,f.role==="user")}),v.role==="user")M(e),e.statusIndicator.textContent="Assistant is thinking...";else if(v.role==="assistant"||v.role==="system"){let f=document.querySelector(".voice-saas-widget-thinking");f&&f.remove(),e.statusIndicator.textContent="Listening..."}})}catch(l){if(o(`Error: ${l.message}`),l.name==="NotAllowedError"){e.statusIndicator.textContent="Microphone access denied";let m=document.createElement("button");m.textContent="\u{1F399}\uFE0F Allow microphone access",m.className="voice-saas-widget-retry-button",Object.assign(m.style,{margin:"10px auto",display:"block",padding:"8px 16px",background:u.themeColor,color:"white",border:"none",borderRadius:"4px",cursor:"pointer"});let y=c.querySelector(".voice-saas-widget-retry-button");y&&y.remove(),e.messagesContainer.appendChild(m),m.addEventListener("click",async()=>{if(m.remove(),navigator.permissions&&navigator.permissions.query)try{let C=await navigator.permissions.query({name:"microphone"});if(o(`Microphone permission status: ${C.state}`),C.state==="denied"){I(e,"Please enable microphone access in your browser settings and refresh the page.",!1);return}}catch(C){o(`Error checking permissions: ${C.message}`)}c.style.display="none",setTimeout(()=>n.click(),500)})}else l.message.includes("WebSocket")?e.statusIndicator.textContent="Network error":e.statusIndicator.textContent="Connection failed"}}else if(g)if(p)a&&(a.localParticipant.unpublishAllTracks(),r&&(r.stop(),r=null),p=!1,e.statusIndicator.textContent="Microphone off",n.style.background="#999");else try{e.statusIndicator.textContent="Requesting microphone access...",r=await(window.LivekitClient||window.livekit).createLocalAudioTrack({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}),await a.localParticipant.publishTrack(r),p=!0,e.statusIndicator.textContent="Listening...",n.style.background=u.themeColor}catch(l){o(`Microphone reactivation error: ${l.message}`),l.name==="NotAllowedError"?e.statusIndicator.textContent="Microphone access denied":l.message.includes("WebSocket")?e.statusIndicator.textContent="Network error":e.statusIndicator.textContent="Could not access microphone"}}),document.addEventListener("click",function l(){i&&i.state==="suspended"&&i.resume().then(()=>o("AudioContext resumed by user interaction")).catch(m=>console.warn("AudioContext resume error:",m)),a&&a.startAudio().then(()=>o("LiveKit audio started by user interaction")).catch(m=>console.warn("LiveKit startAudio error:",m)),document.removeEventListener("click",l)},{once:!0}),window.addEventListener("beforeunload",()=>{r&&(r.stop(),r=null),a&&a.disconnect(),i&&i.state!=="closed"&&i.close().catch(()=>{}),e.audioContainer&&(e.audioContainer.innerHTML="")})}function T(){S(),E(),A()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",T):T(),window.VoiceSaasWidget={version:k,createWidget:function(t){return Object.assign(u,t),S(),E(),A()}}})();})();
//# sourceMappingURL=widget.bundle.js.map
